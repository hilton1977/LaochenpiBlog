---
title: 一致性哈希算法
tags: []
categories: []
toc: false
date: 2020-05-18 15:47:02
---

### 一致性哈希算法
#### 特性
- 平衡性（Balance）：哈希地址尽可能均匀的分布到所有的地址空间之中，充分利用所有的地址空间 
- 单调性（Monotonicity）：当地址空间扩容或缩容时，原有已分配的内容能正确的映射到原有或新的地址空间之中，而一般的哈希算法由于整个地址空间的变化需要重新更新所有的映射关系
- 分散性（Spread）：在分布式环境中，终端有可能看不到所有的缓冲，而是只能看到其中的一部分。当终端希望通过哈希过程将内容映射到缓冲上时，由于不同终端所见的缓冲范围有可能不同，从而导致哈希的结果不一致，最终的结果是相同的内容被不同的终端映射到不同的缓冲区中。这种情况显然是应该避免的，因为它导致相同内容被存储到不同缓冲中去，降低了系统存储的效率。分散性的定义就是上述情况发生的严重程度。好的哈希算法应能够尽量避免不一致的情况发生，也就是尽量降低分散性。
- 负载（Load）：负载问题实际上是从另一个角度看待分散性问题。既然不同的终端可能将相同的内容映射到不同的缓冲区中，那么对于一个特定的缓冲区而言，也可能被不同的用户映射为不同的内容。与分散性一样，这种情况也是应当避免的，因此好的哈希算法应能够尽量降低缓冲的负荷。
- 平滑性（Smoonthness）：平滑性是指缓存服务器的数目平滑改变和缓存对象的平滑改变是一致的

#### 原理
在分布式架构中将服务器通过ip地址进行哈希算法确定在0 ~ 2^32^的**闭环**之中的位置，当我们存入某个缓存时候通过算出`hash(key)`得到哈希值，顺时针找到第一个距离最近的服务器操作，如果当前哈希值超过最大值则从0开始继续查找
![image.png](/images/2020/05/18/c8ff2030-98e4-11ea-baff-f5d93153beb4.png)


#### 节点变化
当架构添加新的服务器或删除，只会影响该新节点逆时针到前一个节点之间的缓存数据，仅需将受影响缓存数据迁移至新节点之中即可，无需更新整个映射关系，如果节点C宕机仅仅是节点B到节点C之间的数据无法使用，其余节点A、B、D都能正常提供服务，对于节点的变化仅需重定位部分数据，具有较好的可扩展性和容错性
![image.png](/images/2020/05/18/d3568690-98e4-11ea-baff-f5d93153beb4.png)

#### 数据倾斜
在圆环之中如果节点过少会造成数据倾斜，大量的数据集中在在一个节点少量数据分布到其他节点，为解决此类问题引入了**虚拟节点机制**，对服务器节点多次计算哈希值作为虚拟节点的值，使其数据更加均匀的分散到个个节点
![image.png](/images/2020/05/18/c3928180-98e6-11ea-ba5c-993f9fbc0aef.png)